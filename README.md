# GeoJSON 坐标批量转换工具

这是一个用于批量转换 GeoJSON 文件中坐标系的 Node.js 脚本工具。

## 功能特性

> **关于坐标转换方式**
> 
> 本工具采用官方地图 API 进行坐标转换，这是**生产环境的标准做法**：
> - 官方 API 转换精度有保障，与地图服务算法完全一致
> - 前端坐标转换库（如 coordtransform、gcoord）可能存在精度误差，不推荐用于批量数据转换
> - 通过智能缓存机制，可有效降低 API 调用成本，兼顾精度和效率

### 核心特性

- **官方 API 转换**：使用百度地图/高德地图官方 API，保证生产环境精度标准
- **批量处理**：批量处理目录下的所有 GeoJSON 文件，支持递归扫描子目录
- **多服务商支持**：支持百度地图 API 和高德地图 API 两种服务提供商
- **智能缓存**：跨文件、跨会话的智能缓存机制，避免重复 API 调用
- **三阶段处理**：扫描文件 → 批量转换坐标 → 保存文件，最大化转换效率
- **配额管理**：API 配额管理，防止超出限制
- **异常保护**：异常中断保护，缓存数据不丢失
- **并发控制**：智能并发控制，提高转换效率
- **增量处理**：自动跳过已转换的文件，支持增量处理

## 安装依赖

```bash
# 在项目根目录执行
npm install
```

或者在 tools 目录单独安装：

```bash
cd tools
npm install axios
```

## 使用方法

### 快速开始（推荐）

最简配置，只需 4 个参数即可开始使用：

```javascript
// 使用百度地图 API
const userConfig = {
  inputDir: './data/input',
  outputDir: './data/output',
  serviceProvider: 'baidu',
  apiKey: 'YOUR_BAIDU_AK'
};

// 或使用高德地图 API
const userConfig = {
  inputDir: './data/input',
  outputDir: './data/output',
  serviceProvider: 'amap',
  apiKey: 'YOUR_AMAP_KEY'
};
```

系统会自动设置：
- 坐标转换方向（百度：WGS84→BD09，高德：WGS84→GCJ02）
- 并发控制参数（根据服务商 API 特性优化）
- 批次大小（符合 API 限制）
- 每日配额
- 缓存文件路径

### 1. 配置脚本（完整说明）

编辑 `convert.js` 文件顶部的配置对象：

**基础配置示例（推荐）**：
```javascript
const userConfig = {
  inputDir: './data/input',        // 输入目录路径
  outputDir: './data/output',      // 输出目录路径
  serviceProvider: 'baidu',        // 地图服务提供商：'baidu' 或 'amap'
  apiKey: 'YOUR_API_KEY'           // API 密钥（百度 AK 或高德 Key）
};
```

**完整配置示例（高级用户）**：
```javascript
const userConfig = {
  // 必需配置
  inputDir: './data/input',
  outputDir: './data/output',
  serviceProvider: 'baidu',        // 'baidu' 或 'amap'
  apiKey: 'YOUR_API_KEY',
  
  // 可选配置（以下为默认值，可按需修改）
  recursive: true,                 // 是否递归扫描子目录
  enableCache: true,               // 是否启用缓存
  retryTimes: 2,                   // 失败重试次数
  retryDelay: 1000,                // 重试延迟（毫秒）
  
  // 高级配置（通常由 serviceProvider 自动设置，高级用户可覆盖）
  sourceCoordType: 'wgs84',        // 源坐标系（自动推断）
  targetCoordType: 'bd09',         // 目标坐标系（自动推断）
  maxConcurrency: 100,             // 最大并发数（自动推断）
  batchSize: 100,                  // 批量大小（自动推断）
  dailyQuota: 150000,              // 每日配额（自动推断）
  cacheFile: './cache/wgs84Tobd09.json'  // 缓存文件路径（自动生成）
};
```

### 2. 准备数据

创建输入目录，并将需要转换的 GeoJSON 文件放入其中：

```
data/
  input/
    city_boundary.geojson
    poi_data.geojson
    roads/
      highway.geojson
      railway.geojson
```

### 3. 运行转换

```bash
node tools/coord-convert/convert.js
```

### 4. 查看结果

转换后的文件将保存在输出目录中，保持相同的目录结构：

```
data/
  output/
    city_boundary.geojson      # 已转换坐标
    poi_data.geojson          # 已转换坐标
    roads/
      highway.geojson         # 已转换坐标
      railway.geojson         # 已转换坐标
```

## 配置说明

### 主要配置项

| 配置项 | 类型 | 说明 | 默认值/自动推断 | 备注 |
|--------|------|------|----------------|------|
| `inputDir` | 必需 | 输入目录路径 | - | 存放原始 GeoJSON 文件 |
| `outputDir` | 必需 | 输出目录路径 | - | 转换后文件保存位置 |
| `serviceProvider` | 必需 | 地图服务提供商 | - | 可选 `'baidu'` 或 `'amap'` |
| `apiKey` | 必需 | API 密钥 | - | 百度 AK 或高德 Key |
| `recursive` | 可选 | 递归扫描子目录 | `true` | 是否处理子目录下的文件 |
| `enableCache` | 可选 | 启用缓存 | `true` | 建议启用，减少 API 调用 |
| `retryTimes` | 可选 | 重试次数 | `2` | API 调用失败时的重试次数 |
| `retryDelay` | 可选 | 重试延迟 | `1000` | 毫秒，采用指数退避策略 |
| `sourceCoordType` | 自动推断 | 源坐标系 | 根据 serviceProvider 推断 | 可手动覆盖，可选 `'wgs84'`, `'gcj02'`, `'bd09'` |
| `targetCoordType` | 自动推断 | 目标坐标系 | 根据 serviceProvider 推断 | 可手动覆盖，可选 `'wgs84'`, `'gcj02'`, `'bd09'` |
| `maxConcurrency` | 自动推断 | 最大并发数 | 百度: 100, 高德: 3 | 控制同时发起的 API 请求数量 |
| `batchSize` | 自动推断 | 批量大小 | 百度: 100, 高德: 40 | 单次批量转换的坐标数量 |
| `dailyQuota` | 自动推断 | 每日配额 | 百度: 150000, 高德: 10000 | 根据 API 服务等级设置 |
| `cacheFile` | 自动推断 | 缓存文件路径 | `./cache/{source}To{target}.json` | 根据坐标转换类型自动生成 |

### 服务提供商预设配置

配置简化后，系统会根据 `serviceProvider` 自动设置相关参数，您只需关注业务配置。

#### 百度地图预设配置

当 `serviceProvider: 'baidu'` 时，自动应用以下配置：

| 配置项 | 预设值 | 说明 |
|--------|--------|------|
| apiKey | 无 | 百度 AK（需在用户配置中覆盖） |
| sourceCoordType | `'wgs84'` | GPS 坐标系 |
| targetCoordType | `'bd09'` | 百度坐标系 |
| maxConcurrency | `100` | 百度 API 支持较高并发 |
| batchSize | `100` | 百度 API 单次最多支持 100 个坐标 |
| dailyQuota | `150000` | 标准配额 |
| cacheFile | `'./cache/wgs84Tobd09.json'` | 自动生成缓存文件路径 |

**适用场景**：WGS84（GPS）坐标转换为百度地图坐标

**自定义转换方向**：如需其他转换方向（如 GCJ02 转 BD09），可手动设置 `sourceCoordType: 'gcj02'`

#### 高德地图预设配置

当 `serviceProvider: 'amap'` 时，自动应用以下配置：

| 配置项 | 预设值 | 说明 |
|--------|--------|------|
| apiKey | 无 | 高德 Key（示例密钥） |
| sourceCoordType | `'wgs84'` | GPS 坐标系 |
| targetCoordType | `'gcj02'` | 国测局坐标系（火星坐标） |
| maxConcurrency | `3` | 保守并发设置，避免触发 QPS 限制 |
| batchSize | `40` | 高德 API 单次最多支持 40 个坐标 |
| dailyQuota | `10000` | 标准配额 |
| cacheFile | `'./cache/wgs84Togcj02.json'` | 自动生成缓存文件路径 |

**适用场景**：WGS84（GPS）或 BD09 坐标转换为高德地图坐标（GCJ02）

**QPS 限制说明**：高德 API 存在 QPS（每秒查询数）限制，预设并发数为 3 可有效避免触发限制（错误码 10021）

#### 参数差异说明

不同服务商的参数差异主要源于以下原因：

- **坐标系差异**：百度使用自有 BD09 坐标系，高德使用国家标准 GCJ02 坐标系
- **API 限制**：高德单次请求最多 40 个坐标点，百度支持 100 个
- **并发控制**：高德存在 QPS 限制需要保守并发，百度支持更高并发
- **配额差异**：不同服务商的标准配额不同

### 坐标系支持矩阵

#### 百度地图 API 支持

| 源坐标系 | 目标坐标系 | 支持状态 |
|----------|-----------|----------|
| WGS84 | BD09 | ✓ 支持 |
| GCJ02 | BD09 | ✓ 支持 |
| BD09 | GCJ02 | ✓ 支持 |
| BD09 | WGS84 | ✗ 不支持（API 限制） |

#### 高德地图 API 支持

| 源坐标系 | 目标坐标系 | 支持状态 |
|----------|-----------|----------|
| WGS84 | GCJ02 | ✓ 支持 |
| BD09 | GCJ02 | ✓ 支持 |
| GCJ02 | GCJ02 | ✓ 支持（直接返回） |
| 任意 | 非 GCJ02 | ✗ 不支持（API 限制） |

### 坐标系说明

- `wgs84`: GPS 坐标系（WGS84）
- `gcj02`: 国测局坐标系（GCJ-02）
- `bd09`: 百度坐标系（BD-09）

### API 密钥获取

#### 百度地图 API
1. 访问 [百度地图开放平台](https://lbsyun.baidu.com/)
2. 创建应用，获取 AK (Access Key)
3. 在配置中设置 `apiKey: '你的百度AK'`

#### 高德地图 API
1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册并登录账号
3. 进入控制台创建应用
4. 选择 Web 服务 API
5. 获取 Key 并在配置中设置 `apiKey`

## 三阶段处理流程

本工具采用三阶段处理流程，最大化转换效率和缓存利用率：

### 第一阶段：扫描文件并收集坐标

- 遍历输入目录下的所有 JSON 文件
- 检查输出文件是否已存在，存在则跳过（支持增量处理）
- 解析 GeoJSON 结构，提取所有坐标点
- 检查每个坐标的缓存状态
- 统计缓存命中数和需转换数

### 第二阶段：批量转换坐标

- 收集所有文件中需要转换的坐标（跨文件去重）
- 按 `batchSize` 分批
- 使用 `p-limit` 控制并发数
- 每批完成后立即更新缓存
- 记录 API 调用次数和配额消耗

### 第三阶段：应用转换结果并保存文件

- 遍历每个文件
- 合并缓存结果和 API 转换结果
- 将转换后的坐标应用到 GeoJSON 对象
- 保持原始目录结构保存输出文件
- 统计成功和失败文件数

### 三阶段流程的优势

- **跨文件去重**：避免重复转换相同坐标
- **最大化缓存利用率**：一次性检查所有坐标的缓存状态
- **减少 API 调用**：集中批量转换，减少请求次数
- **提高整体效率**：并发处理，充分利用网络资源

## 缓存机制详解

> **关于缓存文件**
> 
> - 缓存文件（默认 `./cache/coord-cache.json`）用于存储已转换的坐标，避免重复 API 调用
> - **缓存文件可以安全删除**，程序会自动重建，但删除后需要重新调用 API 转换所有坐标
> - 如果项目中已提交缓存文件到版本控制系统，建议删除并添加到 `.gitignore`
> - 建议每个用户维护自己的缓存文件，不要提交到代码仓库

### 缓存机制特点

| 特性 | 说明 |
|------|------|
| **存储格式** | JSON 文件，键为 `"经度,纬度"` 字符串，值为 `[经度, 纬度]` 数组 |
| **加载时机** | 程序启动时一次性加载到内存（Map 对象） |
| **保存时机** | 每个 API 批次转换完成后立即保存；程序异常退出时自动保存 |
| **作用范围** | 跨文件、跨运行会话复用 |
| **命中策略** | 在扫描阶段检查缓存，分离已缓存和未缓存坐标 |
| **并发安全** | 使用 `isCacheSaving` 标志防止并发保存冲突 |

### 缓存工作流程

1. 程序启动时加载现有缓存文件到内存 Map
2. 第一阶段扫描文件时，检查每个坐标是否在缓存中
3. 第二阶段仅对未缓存的坐标进行 API 转换
4. 每个 API 批次完成后立即将新结果写入缓存文件
5. 异常退出时通过信号处理器保存缓存

### 缓存文件管理建议

**缓存文件特点**：
- 缓存文件是纯文本 JSON 格式，人类可读
- 文件大小取决于转换过的坐标数量
- 每个坐标约占 50-80 字节（含格式化）

**管理建议**：
- **可以删除**：缓存文件可以随时删除，不影响程序运行
- **删除后果**：删除后所有坐标需重新调用 API 转换，消耗配额
- **备份策略**：处理大量数据后建议备份缓存文件
- **清理时机**：当缓存文件过大或坐标系转换需求变更时
- **多任务场景**：不同转换任务可使用不同的缓存文件路径

**版本控制建议**：
- 如果项目中已提交缓存文件，可以安全删除
- 每个用户的转换需求可能不同，不建议提交缓存文件到 Git
- 建议在 `.gitignore` 中添加 `cache/` 目录

## 输出示例

以下是三阶段处理流程的输出示例：

```
[2026-01-08T10:00:00.000Z] INFO: 开始批量坐标转换
[2026-01-08T10:00:00.001Z] INFO: 加载缓存: 5420 条记录

[2026-01-08T10:00:00.002Z] INFO: 第一阶段：扫描文件并收集坐标...
[2026-01-08T10:00:00.003Z] INFO: 扫描文件 [1/15]: city_boundary.geojson
[2026-01-08T10:00:00.004Z] INFO:   坐标: 320 个 | 缓存命中: 85 个 | 需转换: 235 个
...
[2026-01-08T10:00:05.000Z] INFO: 扫描完成: 发现 15 个文件 | 跳过 0 个 | 处理 15 个
[2026-01-08T10:00:05.001Z] INFO: 总坐标 12850 个 | 缓存命中 5420 个 | 需API转换 7430 个

[2026-01-08T10:00:05.002Z] INFO: 第二阶段：批量转换坐标...
[2026-01-08T10:00:05.100Z] INFO: 批次转换完成: 100 个坐标 | API调用 1 次
[2026-01-08T10:00:05.200Z] INFO: 批次转换完成: 100 个坐标 | API调用 2 次
...

[2026-01-08T10:00:40.000Z] INFO: 第三阶段：应用转换结果并保存文件...
[2026-01-08T10:00:40.001Z] INFO: 保存文件 [1/15]: city_boundary.geojson
[2026-01-08T10:00:40.002Z] INFO:   文件保存完成: 耗时 0秒
...

[2026-01-08T10:00:45.000Z] INFO: ----------------------------------------
[2026-01-08T10:00:45.001Z] INFO: 批量转换完成!
[2026-01-08T10:00:45.002Z] INFO: 总文件数: 15 个 | 跳过: 0 个 | 处理: 15 个
[2026-01-08T10:00:45.003Z] INFO: 成功: 15 个 | 失败: 0 个
[2026-01-08T10:00:45.004Z] INFO: 总坐标数: 12850 个 | 缓存命中: 5420 个 | API转换: 7430 个
[2026-01-08T10:00:45.005Z] INFO: API调用: 75 次 | 剩余配额: 4925 次
[2026-01-08T10:00:45.006Z] INFO: 总耗时: 45秒
```

## 注意事项

### 基本注意事项

1. **API 密钥安全**：不要在代码中硬编码真实的 API 密钥，建议使用环境变量或配置文件
2. **配额限制**：注意 API 服务的每日调用限制，超出后需要等待重置或升级服务
3. **网络连接**：确保网络连接稳定，脚本会自动重试失败的请求
4. **大文件处理**：对于包含大量坐标的 GeoJSON 文件，转换可能需要较长时间
5. **缓存管理**：缓存文件可以安全删除，但会导致 API 配额消耗增加

### 坐标转换方式说明

- **使用官方 API**：本工具使用官方地图 API 进行坐标转换，这是生产环境的标准做法
- **精度保证**：前端坐标转换库（如 coordtransform、gcoord 等）可能存在精度误差，不适合批量数据转换
- **算法一致性**：官方 API 转换结果精度有保障，与地图服务使用的算法完全一致
- **成本控制**：通过缓存机制可有效控制 API 调用成本，兼顾精度和效率

### 服务提供商特定注意事项

- **高德 API**：单次最多支持 40 个坐标点，使用时将 `batchSize` 设置为 40 或更小
- **高德 API**：只能转换为 GCJ02 坐标系，使用时将 `targetCoordType` 设置为 `'gcj02'`
- **百度 API**：不支持将坐标转换为 WGS84 坐标系
- **三阶段处理**：会在第一阶段扫描所有文件后才开始转换，大量文件时需要等待
- **增量处理**：输出文件已存在时会自动跳过，如需重新转换请先删除输出文件

## 故障排除

### 常见错误

| 错误信息 | 原因 | 解决方案 |
|----------|------|----------|
| "配置不完整" | 缺少必要配置项 | 检查 `inputDir`、`outputDir`、`apiKey` 是否正确设置 |
| "百度API错误: 4" | API 配额不足或不支持转换 | 等待配额重置或升级服务；检查坐标系支持 |
| "百度API错误: 5" 或 "高德API错误" | API 密钥无效 | 检查密钥是否正确 |
| "输入目录不存在" | 输入路径错误 | 检查 `inputDir` 路径是否正确 |
| "高德 API 单次最多支持 40 个坐标点" | `batchSize` 设置过大 | 使用高德时将 `batchSize` 设置为 40 或更小 |
| "高德 API 只能转换为 GCJ02 坐标系" | 目标坐标系设置错误 | 使用高德时将 `targetCoordType` 设置为 `'gcj02'` |
| "不支持将坐标转换为 WGS84(GPS)坐标系" | 百度 API 限制 | 改用其他服务或使用算法转换 |
| 输出文件为空或格式错误 | 输入文件不是有效的 GeoJSON | 检查输入文件格式 |
| 程序卡住不动 | 并发数过高或网络问题 | 降低 `maxConcurrency` 值；检查网络连接 |
| 网络超时 | 网络不稳定 | 检查网络连接，脚本会自动重试 |

### 日志级别

脚本使用以下日志级别：
- `INFO`: 正常运行信息
- `WARN`: 警告信息，不影响运行
- `ERROR`: 错误信息，可能导致程序终止

## 扩展开发

### 添加新的地图服务

1. 在 `convertCoordinates` 函数中添加新的服务提供商判断
2. 实现对应的 API 调用函数（如 `convertBatchTencent`）
3. 更新配置验证逻辑

### 支持新的坐标系

1. 在坐标类型映射表中添加新的坐标系编码
2. 测试转换精度和 API 支持情况

### 优化性能

1. 实现流式处理大文件
2. 添加更智能的缓存清理策略
3. 优化并发控制算法
